name: ğŸ”„ AI STV PREMIUM - AUTO RESTART NO DELAY

on:
  workflow_dispatch:
  schedule:
    # Restart otomatis setiap 6 jam tanpa jeda
    - cron: '0 */6 * * *'

jobs:
  Immediate-Restart:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 jam maksimal
    permissions:
      contents: write
      actions: write
    
    steps:
      # STEP 1: LOAD BACKUP DATA DAN LANGSUNG RESTART
      - name: ğŸš€ LOAD & IMMEDIATE RESTART
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
          PREVIOUS_RUN_ID: ${{ github.run_id }}
        run: |
          Write-Host ""
          Write-Host "ğŸš€ SISTEM RESTART TANPA JEDA" -ForegroundColor Yellow
          Write-Host "âš¡ Mode: Instant Restart" -ForegroundColor Red
          Write-Host "â° Waktu: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor White
          
          # HAPUS SEMUA JEDA DAN COUNTDOWN
          # Langsung ke proses utama tanpa delay
          
          # Buat flag untuk restart instant
          $instantFlag = @{
              ImmediateRestart = $true
              PreviousRunID = $env:PREVIOUS_RUN_ID
              RestartTime = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              NoDelay = $true
          } | ConvertTo-Json
          
          $instantFlag | Out-File "$env:TEMP\instant_restart.json"
          
          Write-Host "âœ… Flag restart instant dibuat" -ForegroundColor Green
          
          # Langsung lanjut ke proses setup tanpa jeda

      # STEP 2: SETUP CEPAT TANPA BACKUP AWAL (Gunakan backup dari run sebelumnya)
      - name: âš¡ QUICK SETUP (NO INITIAL BACKUP)
        run: |
          Write-Host ""
          Write-Host "âš¡ SETUP CEPAT TANPA JEDA" -ForegroundColor Yellow
          
          # Cek apakah ada backup dari run sebelumnya
          $backupExists = Test-Path "$env:TEMP\AISTV_Backup"
          if ($backupExists) {
              Write-Host "â”‚ ğŸ”„ Menggunakan backup existing" -ForegroundColor Green
          } else {
              Write-Host "â”‚ ğŸ“¦ Membuat backup minimal" -ForegroundColor Blue
              New-Item -ItemType Directory -Path "$env:TEMP\AISTV_Backup" -Force | Out-Null
          }
          
          # Setup RDP tanpa delay
          $steps = @(
              @{Name="Aktifkan RDP"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Nonaktifkan auth network"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Buka firewall 3389"; Script={
                  netsh advfirewall firewall add rule name="RDP-Instant" dir=in action=allow protocol=TCP localport=3389
                  netsh advfirewall firewall add rule name="RDP-Instant-Out" dir=out action=allow protocol=TCP localport=3389
              }},
              @{Name="Start services"; Script={
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "â”‚ âš¡ $($step.Name)" -ForegroundColor White
              try {
                  & $step.Script
              } catch {
                  Write-Host "â”‚ âš ï¸  $($step.Name) - Skip minor error" -ForegroundColor Yellow
              }
          }
          
          Write-Host "âœ… Setup cepat selesai" -ForegroundColor Green

      # STEP 3: BUAT USER DENGAN PASSWORD SAMA (jika ada backup)
      - name: ğŸ”„ RESTORE USER (INSTANT)
        run: |
          Write-Host ""
          Write-Host "ğŸ”„ RESTORE USER INSTANT" -ForegroundColor Yellow
          
          # Coba baca password dari backup sebelumnya
          $backupPassPath = "$env:TEMP\AISTV_Backup\Config\secure_password.txt"
          if (Test-Path $backupPassPath) {
              try {
                  $securePass = Get-Content $backupPassPath | ConvertTo-SecureString
                  $cred = New-Object System.Management.Automation.PSCredential("dummy", $securePass)
                  $plainPass = $cred.GetNetworkCredential().Password
                  Write-Host "â”‚ ğŸ”„ Menggunakan password dari backup sebelumnya" -ForegroundColor Green
              } catch {
                  $plainPass = $null
              }
          }
          
          if (-not $plainPass) {
              # Generate password baru jika tidak ada backup
              $chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789'
              $plainPass = -join ((1..8) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
              Write-Host "â”‚ ğŸ” Membuat password baru" -ForegroundColor Blue
          }
          
          # Hapus user lama jika ada
          try {
              Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          } catch { }
          
          # Buat user baru
          $securePass = ConvertTo-SecureString $plainPass -AsPlainText -Force
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM"
          Enable-LocalUser -Name "AISTV-PREMIUM"
          
          # Simpan password untuk step berikutnya
          $plainPass | Out-File "$env:TEMP\instant_password.txt"
          echo "RDP_PASS=$plainPass" >> $env:GITHUB_ENV
          
          Write-Host "âœ… User restored: AISTV-PREMIUM" -ForegroundColor Green

      # STEP 4: TAILSCALE INSTANT CONNECT
      - name: ğŸŒ TAILSCALE INSTANT
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "ğŸŒ TAILSCALE INSTANT CONNECT" -ForegroundColor Yellow
          
          # Install Tailscale jika belum ada
          $tailscalePath = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscalePath)) {
              Write-Host "â”‚ ğŸ“¦ Installing Tailscale..." -ForegroundColor Blue
              $msiPath = "$env:TEMP\tailscale.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          }
          
          # Connect Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-instant-$env:GITHUB_RUN_ID --reset --accept-routes --accept-dns
          
          # Get IP tanpa delay
          Start-Sleep -Seconds 3
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
          if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
              echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
              Write-Host "âœ… IP Address: $ip" -ForegroundColor Green
          } else {
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
              Write-Host "âš ï¸  Using localhost" -ForegroundColor Yellow
          }

      # STEP 5: BACKGROUND AUTO-RESTART MONITOR (TANPA JEDA)
      - name: ğŸ”„ INSTANT RESTART MONITOR
        run: |
          Write-Host ""
          Write-Host "ğŸ”„ INSTANT RESTART MONITOR" -ForegroundColor Yellow
          Write-Host "â° Restart dalam: 6 jam (tanpa jeda)" -ForegroundColor Red
          
          # Setup restart timer
          $restartInterval = 6 * 60 * 60  # 6 jam dalam detik
          $startTime = Get-Date
          $restartTime = $startTime.AddSeconds($restartInterval)
          
          # Background process untuk restart otomatis
          $restartScript = {
              param($restartSeconds)
              Start-Sleep -Seconds $restartSeconds
              
              # Trigger restart workflow baru tanpa delay
              $token = $env:GITHUB_TOKEN
              $owner = $env:GITHUB_REPOSITORY_OWNER
              $repo = $env:GITHUB_REPOSITORY
              
              $uri = "https://api.github.com/repos/$owner/$repo/actions/workflows/self-restart.yml/dispatches"
              $body = @{
                  ref = "main"
                  inputs = @{
                      immediate = "true"
                  }
              } | ConvertTo-Json
              
              $headers = @{
                  Authorization = "token $token"
                  Accept = "application/vnd.github.v3+json"
              }
              
              try {
                  Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
                  Write-Host "[AUTO-RESTART] Workflow baru berhasil dipicu" -ForegroundColor Green
              } catch {
                  Write-Host "[AUTO-RESTART] Error: $_" -ForegroundColor Red
              }
              
              # Langsung matikan services untuk mempercepat
              Stop-Service TermService -Force -ErrorAction SilentlyContinue
              Stop-Service UmRdpService -Force -ErrorAction SilentlyContinue
          }
          
          # Jalankan script restart di background
          Start-Job -ScriptBlock $restartScript -ArgumentList $restartInterval
          
          Write-Host "âœ… Auto-restart monitor aktif" -ForegroundColor Green

      # STEP 6: SHOW INFO & MAINTAIN SESSION (TANPA COUNTDOWN)
      - name: ğŸ¯ INSTANT SESSION INFO
        run: |
          $password = Get-Content "$env:TEMP\instant_password.txt" -ErrorAction SilentlyContinue
          if (-not $password) { $password = "Check_GitHub_Secrets" }
          
          $startTime = Get-Date
          $restartTime = $startTime.AddHours(6)
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚         ğŸš€ AI STV PREMIUM - INSTANT MODE         â”‚" -ForegroundColor Red
          Write-Host "â”‚         âš¡ NO DELAY - IMMEDIATE RESTART          â”‚" -ForegroundColor Yellow
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ IP Address: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ Username: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Password: $password" -ForegroundColor White
          Write-Host "â”‚ â° Session Start: $($startTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ”„ Auto Restart: $($restartTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ âš¡ Mode: Instant (No 10s Delay)" -ForegroundColor Red
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          
          # Simpan session info untuk recovery
          $sessionInfo = @{
              IP = $env:TAILSCALE_IP
              Username = "AISTV-PREMIUM"
              StartTime = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
              RestartTime = $restartTime.ToString("yyyy-MM-dd HH:mm:ss")
              Mode = "Instant-NoDelay"
          } | ConvertTo-Json
          
          $sessionInfo | Out-File "$env:TEMP\session_info.json"

      # STEP 7: MAINTAIN SESSION UNTIL RESTART
      - name: â³ MAINTAIN INSTANT SESSION
        run: |
          Write-Host ""
          Write-Host "â³ MENJAGA SESSI HINGGA RESTART..." -ForegroundColor Yellow
          
          $sessionStart = Get-Date
          $restartTime = $sessionStart.AddHours(6)
          $checkInterval = 30  # detik
          
          while ($true) {
              $currentTime = Get-Date
              $timeRemaining = $restartTime - $currentTime
              
              if ($timeRemaining.TotalSeconds -le 0) {
                  Write-Host ""
                  Write-Host "ğŸ”„ WAKTU RESTART TELAH TIBA!" -ForegroundColor Red
                  Write-Host "âš¡ Langsung restart tanpa jeda..." -ForegroundColor Yellow
                  
                  # Trigger restart workflow baru
                  $token = $env:GITHUB_TOKEN
                  $owner = $env:GITHUB_REPOSITORY_OWNER
                  $repo = $env:GITHUB_REPOSITORY
                  
                  $uri = "https://api.github.com/repos/$owner/$repo/actions/workflows/self-restart.yml/dispatches"
                  $body = @{
                      ref = "main"
                  } | ConvertTo-Json
                  
                  $headers = @{
                      Authorization = "token $token"
                      Accept = "application/vnd.github.v3+json"
                  }
                  
                  try {
                      Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
                      Write-Host "âœ… Workflow restart berhasil dipicu" -ForegroundColor Green
                  } catch {
                      Write-Host "âš ï¸  Gagal trigger workflow: $_" -ForegroundColor Yellow
                  }
                  
                  # Langsung exit tanpa delay
                  break
              }
              
              $hours = [math]::Floor($timeRemaining.TotalHours)
              $minutes = [math]::Floor($timeRemaining.TotalMinutes % 60)
              $seconds = [math]::Floor($timeRemaining.TotalSeconds % 60)
              
              Write-Host "`râ³ Restart dalam: $hours jam $minutes menit $seconds detik" -NoNewline -ForegroundColor Cyan
              
              # Cek status services setiap iterasi
              $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
              if ($termService.Status -ne 'Running') {
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
              }
              
              Start-Sleep -Seconds $checkInterval
          }

      # STEP 8: CLEANUP INSTANT (Optional)
      - name: ğŸ§¹ INSTANT CLEANUP
        if: always()
        run: |
          Write-Host ""
          Write-Host "ğŸ§¹ INSTANT CLEANUP" -ForegroundColor Yellow
          
          # Hanya cleanup ringan, biarkan heavy cleanup ke workflow baru
          try {
              # Stop services
              Stop-Service TermService -Force -ErrorAction SilentlyContinue
              Stop-Service UmRdpService -Force -ErrorAction SilentlyContinue
              
              # Down Tailscale
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
              
              # Hapus file temporary
              Remove-Item "$env:TEMP\instant_password.txt" -ErrorAction SilentlyContinue
              Remove-Item "$env:TEMP\instant_restart.json" -ErrorAction SilentlyContinue
              
              Write-Host "âœ… Cleanup selesai" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸  Cleanup partial" -ForegroundColor Yellow
          }
          
          Write-Host "âš¡ Langsung restart dalam 0 detik..." -ForegroundColor Red
