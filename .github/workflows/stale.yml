name: ğŸš€ SEVER AI STV PREMIUM WITH BACKUP

on:
  workflow_dispatch:
  schedule:
    # Menjalankan otomatis setiap 6 jam untuk restart
    - cron: '0 */6 * * *'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 0  # Tidak giá»›i háº¡n thá»i gian
    
    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ğŸ¤– AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "ğŸ’¾ Sistem Backup: AKTIF" -ForegroundColor Cyan
          Write-Host "ğŸ”„ Backup otomatis setiap 1 jam" -ForegroundColor Magenta
          Write-Host "ğŸ“¦ Penyimpanan: Internal + External" -ForegroundColor Blue
          Write-Host ""
          
          # Hiá»‡u á»©ng loading
          $frames = @('â£¾', 'â£½', 'â£»', 'â¢¿', 'â¡¿', 'â£Ÿ', 'â£¯', 'â£·')
          for($i=0; $i -lt 10; $i++) {
              Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 100
          }
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!                    " -ForegroundColor Green

      # INISIALISASI SISTEM BACKUP
      - name: ğŸ’¾ INISIALISASI SISTEM BACKUP
        run: |
          Write-Host ""
          Write-Host "ğŸ’¾ INISIALISASI SISTEM BACKUP" -ForegroundColor Yellow
          
          # Buat struktur folder backup
          $backupDir = "$env:TEMP\AISTV_Backup"
          $backupDirs = @(
              "$backupDir",
              "$backupDir\Registry",
              "$backupDir\Config",
              "$backupDir\System",
              "$backupDir\Logs",
              "$backupDir\Users",
              "$backupDir\Network",
              "$backupDir\Scheduled"
          )
          
          foreach($dir in $backupDirs) {
              New-Item -ItemType Directory -Path $dir -Force | Out-Null
          }
          
          # File konfigurasi backup
          $backupConfig = @{
              BackupEnabled = $true
              BackupInterval = 3600  # 1 jam dalam detik
              RetentionDays = 7
              MaxBackupFiles = 10
              LastBackupTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
              BackupLocation = $backupDir
          } | ConvertTo-Json
          
          $backupConfig | Out-File "$backupDir\backup_config.json"
          
          echo "BACKUP_DIR=$backupDir" >> $env:GITHUB_ENV
          echo "BACKUP_ENABLED=true" >> $env:GITHUB_ENV
          
          Write-Host "â”‚ âœ… Struktur folder backup dibuat" -ForegroundColor Green
          Write-Host "â”‚ ğŸ“ Lokasi: $backupDir" -ForegroundColor White
          Write-Host "â”‚ â° Interval: Setiap 1 jam" -ForegroundColor White
          Write-Host "â”‚ ğŸ“† Retensi: 7 hari" -ForegroundColor White
          Write-Host "ğŸ¯ Sistem backup siap!" -ForegroundColor Green

      # Cáº¤U HÃŒNH NÃ‚NG CAO
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ› ï¸  ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
          
          $steps = @(
              @{Name="Báº­t Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Táº¯t xÃ¡c thá»±c máº¡ng"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Cáº¥u hÃ¬nh báº£o máº­t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Má»Ÿ port 3389 firewall"; Script={
                  netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "â”‚ ğŸ“‹ $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`râ”‚ âš ï¸  $($step.Name) - ÄÃ£ bá» qua lá»—i nhá»" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "ğŸ¯ Cáº¥u hÃ¬nh hoÃ n táº¥t!" -ForegroundColor Green

      # Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
          
          function New-PremiumPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
              Write-Host "â”‚ â„¹ï¸  DÃ¹ng máº­t kháº©u tÃ¹y chá»‰nh tá»« env" -ForegroundColor Blue
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          # Backup user lama jika ada
          try {
              $oldUser = Get-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              if ($oldUser) {
                  $oldUserInfo = @{
                      Name = $oldUser.Name
                      Enabled = $oldUser.Enabled
                      LastLogon = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                  } | ConvertTo-Json
                  $oldUserInfo | Out-File "$env:BACKUP_DIR\Users\old_user_backup.json"
                  Write-Host "â”‚ ğŸ’¾ Backup user lama dibuat" -ForegroundColor Cyan
              }
          } catch { }
          
          # XÃ³a user cÅ©
          try {
              Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… ÄÃ£ xÃ³a user cÅ©" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ â„¹ï¸  KhÃ´ng cÃ³ user cÅ© Ä‘á»ƒ xÃ³a" -ForegroundColor Blue
          }
          
          # Táº¡o user má»›i
          try {
              New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
              Write-Host "â”‚ âœ… ÄÃ£ táº¡o user má»›i" -ForegroundColor Green
              
              try {
                  Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
              } catch { }

              Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              
              Enable-LocalUser -Name "AISTV-PREMIUM"
              
              Write-Host "â”‚ âœ… ÄÃ£ cáº¥p quyá»n Administrator & RDP" -ForegroundColor Green
              
          } catch {
              Write-Host "â”‚ âŒ Lá»—i táº¡o user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }
          
          # Simpan informasi user ke backup
          $userInfo = @{
              Username = "AISTV-PREMIUM"
              Created = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              Groups = @("Administrators", "Remote Desktop Users", "Users")
              Status = "Active"
          } | ConvertTo-Json
          
          $userInfo | Out-File "$env:BACKUP_DIR\Users\user_info.json"
          
          # Simpan password dengan aman (encrypted)
          $securePasswordPath = "$env:BACKUP_DIR\Config\secure_password.txt"
          $matKhau | ConvertTo-SecureString -AsPlainText -Force | ConvertFrom-SecureString | Out-File $securePasswordPath
          
          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          
          Write-Host "â”‚ ğŸ’¾ Backup informasi user disimpan" -ForegroundColor Cyan
          Write-Host "âœ… TÃ i khoáº£n: AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      # BACKUP KONFIGURASI AWAL
      - name: ğŸ“¦ BACKUP KONFIGURASI AWAL
        run: |
          Write-Host ""
          Write-Host "ğŸ“¦ BACKUP KONFIGURASI AWAL" -ForegroundColor Yellow
          
          try {
              # Backup registry settings
              $regKeys = @(
                  "HKLM:\System\CurrentControlSet\Control\Terminal Server",
                  "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp",
                  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
              )
              
              foreach($key in $regKeys) {
                  $regFile = "$env:BACKUP_DIR\Registry\$($key.Replace(':','').Replace('\','_')).reg"
                  reg export $key.Replace('HKLM:\','HKLM\') $regFile /y 2>$null
              }
              Write-Host "â”‚ âœ… Registry settings di-backup" -ForegroundColor Green
              
              # Backup firewall rules
              $firewallRules = netsh advfirewall firewall show rule name=all
              $firewallRules | Out-File "$env:BACKUP_DIR\Network\firewall_rules.txt"
              Write-Host "â”‚ âœ… Firewall rules di-backup" -ForegroundColor Green
              
              # Backup service configuration
              $services = Get-Service TermService, UmRdpService, SessionEnv, Netlogon
              $services | Select-Object Name, DisplayName, Status, StartType | ConvertTo-Json | Out-File "$env:BACKUP_DIR\System\services.json"
              Write-Host "â”‚ âœ… Service configuration di-backup" -ForegroundColor Green
              
              # Backup system info
              systeminfo | Out-File "$env:BACKUP_DIR\System\system_info.txt"
              Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, OsHardwareAbstractionLayer | ConvertTo-Json | Out-File "$env:BACKUP_DIR\System\computer_info.json"
              Write-Host "â”‚ âœ… System information di-backup" -ForegroundColor Green
              
              # Backup network configuration
              ipconfig /all | Out-File "$env:BACKUP_DIR\Network\network_config.txt"
              Get-NetIPConfiguration | ConvertTo-Json | Out-File "$env:BACKUP_DIR\Network\ip_config.json"
              Write-Host "â”‚ âœ… Network configuration di-backup" -ForegroundColor Green
              
              # Buat timestamp backup
              $backupInfo = @{
                  BackupType = "Initial"
                  Timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                  Version = "1.0"
                  Components = @("Registry", "Firewall", "Services", "System", "Network")
              } | ConvertTo-Json
              
              $backupInfo | Out-File "$env:BACKUP_DIR\backup_manifest.json"
              
              # Kompres backup
              $backupZip = "$env:TEMP\AISTV_Initial_Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
              Compress-Archive -Path "$env:BACKUP_DIR\*" -DestinationPath $backupZip -Force
              
              echo "INITIAL_BACKUP=$backupZip" >> $env:GITHUB_ENV
              
              Write-Host "â”‚ ğŸ“¦ Backup awal berhasil dibuat" -ForegroundColor Green
              Write-Host "â”‚ ğŸ“ File: $backupZip" -ForegroundColor White
              Write-Host "â”‚ ğŸ“Š Ukuran: $([math]::Round((Get-Item $backupZip).Length/1MB, 2)) MB" -ForegroundColor White
              
          } catch {
              Write-Host "â”‚ âš ï¸  Backup awal mengalami masalah kecil: $_" -ForegroundColor Yellow
          }
          
          Write-Host "ğŸ¯ Backup konfigurasi awal selesai!" -ForegroundColor Green

      # KIá»‚M TRA QUYá»€N ÄÄ‚NG NHáº¬P
      - name: ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ” KIá»‚M TRA QUYá»€N ÄÄ‚NG NHáº¬P" -ForegroundColor Yellow
          
          $user = Get-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
          if ($user) {
              Write-Host "â”‚ âœ… User AISTV-PREMIUM tá»“n táº¡i" -ForegroundColor Green
              Write-Host "â”‚ ğŸ“Š Tráº¡ng thÃ¡i: $($user.Enabled)" -ForegroundColor White
          } else {
              Write-Host "â”‚ âŒ User tidak tá»“n táº¡i" -ForegroundColor Red
              exit 1
          }
          
          $isAdmin = (Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*AISTV-PREMIUM"}).Count -gt 0
          if ($isAdmin) {
              Write-Host "â”‚ âœ… CÃ³ quyá»n Administrator" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ Tidak ada quyá»n Administrator" -ForegroundColor Red
          }
          
          $isRDPUser = (Get-LocalGroupMember -Group "Remote Desktop Users" | Where-Object {$_.Name -like "*AISTV-PREMIUM"}).Count -gt 0
          if ($isRDPUser) {
              Write-Host "â”‚ âœ… CÃ³ quyá»n Remote Desktop" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ Tidak ada quyá»n Remote Desktop" -ForegroundColor Red
          }
          
          $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
          if ($termService.Status -eq 'Running') {
              Write-Host "â”‚ âœ… Dá»‹ch vá»¥ TermService Ä‘ang cháº¡y" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ Dá»‹ch vá»¥ TermService khÃ´ng cháº¡y" -ForegroundColor Red
          }
          
          Write-Host "ğŸ¯ Kiá»ƒm tra hoÃ n táº¥t!" -ForegroundColor Green

      # TAILSCALE PREMIUM
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG" -ForegroundColor Yellow
          
          # Backup network config sebelum perubahan
          $preNetworkConfig = @{
              Timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              Interfaces = Get-NetIPConfiguration | Select-Object InterfaceAlias, IPv4Address
              DNS = (Get-DnsClientServerAddress | Where-Object {$_.InterfaceAlias -like "*Ethernet*" -or $_.InterfaceAlias -like "*Wi-Fi*"}).ServerAddresses
          } | ConvertTo-Json
          
          $preNetworkConfig | Out-File "$env:BACKUP_DIR\Network\pre_tailscale_config.json"
          
          try {
              $msiPath = "$env:TEMP\tailscale-premium.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… CÃ i Ä‘áº·t Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âŒ Lá»—i cÃ i Ä‘áº·t Tailscale" -ForegroundColor Red
          }
          
          Start-Sleep -Seconds 10
          
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
              Write-Host "â”‚ âœ… Káº¿t ná»‘i Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
              
              # Backup Tailscale config
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | Out-File "$env:BACKUP_DIR\Network\tailscale_status.json"
              & "$env:ProgramFiles\Tailscale\tailscale.exe" netcheck | Out-File "$env:BACKUP_DIR\Network\tailscale_netcheck.txt"
              
          } catch {
              Write-Host "â”‚ âŒ Lá»—i káº¿t ná»‘i Tailscale" -ForegroundColor Red
          }
          
          Write-Host "ğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP..." -NoNewline -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      echo "TAILSCALE_IP_BACKUP=$ip" >> $env:GITHUB_ENV
                      
                      # Simpan IP ke backup
                      @{
                          TailscaleIP = $ip
                          Timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                          Hostname = "ai-stv-premium-$env:GITHUB_RUN_ID"
                      } | ConvertTo-Json | Out-File "$env:BACKUP_DIR\Network\tailscale_ip.json"
                      
                      Write-Host "`râœ… Äá»‹a chá»‰ IP: $ip" -ForegroundColor Green
                      break
                  }
              } catch { }
              Write-Host "`rğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
              Write-Host "`râš ï¸  KhÃ´ng thá»ƒ láº¥y IP, sá»­ dá»¥ng localhost" -ForegroundColor Yellow
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
              echo "TAILSCALE_IP_BACKUP=localhost" >> $env:GITHUB_ENV
          }

      # SISTEM BACKUP OTOMATIS (BERJALAN DI BACKGROUND)
      - name: ğŸ”„ SISTEM BACKUP OTOMATIS
        run: |
          Write-Host ""
          Write-Host "ğŸ”„ SISTEM BACKUP OTOMATIS DIHIDUPKAN" -ForegroundColor Yellow
          Write-Host "â° Interval: Setiap 1 jam" -ForegroundColor Cyan
          Write-Host "ğŸ“ Lokasi: $env:BACKUP_DIR\Scheduled" -ForegroundColor White
          Write-Host "ğŸ’¾ Mode: Incremental + Full" -ForegroundColor Magenta
          
          # Script backup otomatis (berjalan di background)
          $backupScript = {
              $backupBase = "$env:TEMP\AISTV_Backup\Scheduled"
              $backupCount = 0
              $lastFullBackup = Get-Date
              
              while ($true) {
                  $currentTime = Get-Date
                  $backupType = "Incremental"
                  
                  # Buat full backup setiap 6 jam
                  if (($currentTime - $lastFullBackup).TotalHours -ge 6) {
                      $backupType = "Full"
                      $lastFullBackup = $currentTime
                  }
                  
                  $backupFolder = "$backupBase\$backupType`_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
                  New-Item -ItemType Directory -Path $backupFolder -Force | Out-Null
                  
                  try {
                      # Backup registry RDP
                      reg export "HKLM\System\CurrentControlSet\Control\Terminal Server" "$backupFolder\rdp_registry.reg" /y 2>$null
                      
                      # Backup service status
                      Get-Service TermService, UmRdpService | Select-Object Name, Status | Export-Csv "$backupFolder\services.csv" -NoTypeInformation
                      
                      # Backup network connections
                      Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Select-Object LocalAddress, RemoteAddress, State | Export-Csv "$backupFolder\rdp_connections.csv" -NoTypeInformation
                      
                      # Backup event logs
                      Get-EventLog -LogName Application -Source "TermServ*" -Newest 50 | Select-Object TimeGenerated, EntryType, Source, Message | Export-Csv "$backupFolder\event_logs.csv" -NoTypeInformation
                      
                      # Backup user session
                      query user 2>$null | Out-File "$backupFolder\user_sessions.txt"
                      
                      # Backup system performance
                      $cpu = Get-WmiObject Win32_Processor | Measure-Object -Property LoadPercentage -Average | Select-Object Average
                      $ram = Get-WmiObject Win32_OperatingSystem | Select-Object @{Name="FreeMemoryMB";Expression={[math]::Round($_.FreePhysicalMemory/1024,2)}}
                      
                      @{
                          Timestamp = $currentTime.ToString("yyyy-MM-dd HH:mm:ss")
                          BackupType = $backupType
                          BackupNumber = ++$backupCount
                          CPUUsage = $cpu.Average
                          FreeMemoryMB = $ram.FreeMemoryMB
                          RDPConnections = @(Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}).Count
                      } | ConvertTo-Json | Out-File "$backupFolder\backup_info.json"
                      
                      # Kompres backup
                      $backupZip = "$backupFolder.zip"
                      Compress-Archive -Path "$backupFolder\*" -DestinationPath $backupZip -Force
                      Remove-Item $backupFolder -Recurse -Force -ErrorAction SilentlyContinue
                      
                      # Log backup
                      Write-Host "[BACKUP $backupType] $(Get-Date -Format 'HH:mm:ss') - Backup #$backupCount berhasil ($([math]::Round((Get-Item $backupZip).Length/1KB, 2)) KB)" -ForegroundColor Cyan
                      
                      # Cleanup backup lama (pertahankan 10 terbaru)
                      $oldBackups = Get-ChildItem "$backupBase\*.zip" | Sort-Object LastWriteTime -Descending | Select-Object -Skip 10
                      foreach($oldBackup in $oldBackups) {
                          Remove-Item $oldBackup.FullName -Force -ErrorAction SilentlyContinue
                          Write-Host "[BACKUP CLEANUP] Menghapus backup lama: $($oldBackup.Name)" -ForegroundColor Gray
                      }
                      
                  } catch {
                      Write-Host "[BACKUP ERROR] $(Get-Date -Format 'HH:mm:ss') - $($_.Exception.Message)" -ForegroundColor Red
                  }
                  
                  # Tunggu 1 jam untuk backup berikutnya
                  Start-Sleep -Seconds 3600
              }
          }
          
          # Jalankan backup service di background
          Start-Job -ScriptBlock $backupScript -Name "AutoBackupService"
          
          Write-Host "âœ… Sistem backup otomatis berjalan di background" -ForegroundColor Green

      # JEDA 10 DETIK SEBELUM RESTART
      - name: â¸ï¸ JEDA SEBELUM RESTART
        run: |
          Write-Host ""
          Write-Host "â¸ï¸  JEDA 10 DETIK SEBELUM RESTART" -ForegroundColor Yellow
          Write-Host "ğŸ’¾ Membuat backup final sebelum restart..." -ForegroundColor Cyan
          
          # Buat backup final sebelum restart
          try {
              $finalBackupDir = "$env:TEMP\Final_Backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
              New-Item -ItemType Directory -Path $finalBackupDir -Force | Out-Null
              
              # Backup semua konfigurasi penting
              $backupItems = @{
                  "User_Info" = { Get-LocalUser -Name "AISTV-PREMIUM" | Select-Object Name, Enabled, LastLogon | ConvertTo-Json }
                  "Network_Status" = { & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json }
                  "Services_Status" = { Get-Service TermService, UmRdpService | Select-Object Name, Status, StartType | ConvertTo-Json }
                  "Firewall_Rules" = { netsh advfirewall firewall show rule name="RDP-Premium" }
                  "System_Uptime" = { (Get-Date) - (Get-CimInstance -ClassName Win32_OperatingSystem).LastBootUpTime }
              }
              
              foreach($item in $backupItems.GetEnumerator()) {
                  try {
                      & $item.Value | Out-File "$finalBackupDir\$($item.Key).txt"
                  } catch {
                      # Skip error
                  }
              }
              
              # Kompres backup final
              $finalBackupZip = "$env:TEMP\AISTV_Final_Backup.zip"
              Compress-Archive -Path "$finalBackupDir\*" -DestinationPath $finalBackupZip -Force
              Remove-Item $finalBackupDir -Recurse -Force
              
              Write-Host "â”‚ âœ… Backup final dibuat: $finalBackupZip" -ForegroundColor Green
              echo "FINAL_BACKUP=$finalBackupZip" >> $env:GITHUB_ENV
              
          } catch {
              Write-Host "â”‚ âš ï¸  Gagal membuat backup final" -ForegroundColor Yellow
          }
          
          Write-Host "ğŸ”„ Sistem akan restart dalam 10 detik..." -ForegroundColor Cyan
          
          $seconds = 10
          for($i = $seconds; $i -gt 0; $i--) {
              Write-Host "`râ³ Restart dalam: $i detik" -NoNewline -ForegroundColor Green
              Start-Sleep -Seconds 1
          }
          Write-Host "`rğŸš€ Memulai restart sistem...                " -ForegroundColor Yellow

      # RESTART OTOMATIS SETELAH 6 JAM
      - name: ğŸ”„ RESTART OTOMATIS (6 JAM)
        run: |
          Write-Host ""
          Write-Host "ğŸ”„ SISTEM RESTART OTOMATIS" -ForegroundColor Yellow
          Write-Host "ğŸ’¾ Backup aktif selama operasi" -ForegroundColor Cyan
          Write-Host "â° Konfigurasi: Restart setiap 6 jam" -ForegroundColor Magenta
          
          $restartInterval = 6 * 60 * 60
          $restartCount = 0
          $startTime = Get-Date
          $backupInterval = 3600  # Backup setiap 1 jam
          $lastBackupTime = Get-Date
          
          while ($true) {
              $currentTime = Get-Date
              $elapsed = ($currentTime - $startTime).TotalSeconds
              
              # Backup otomatis setiap 1 jam
              if (($currentTime - $lastBackupTime).TotalSeconds -ge $backupInterval) {
                  try {
                      $hourlyBackupDir = "$env:TEMP\Hourly_Backup_$(Get-Date -Format 'HHmmss')"
                      New-Item -ItemType Directory -Path $hourlyBackupDir -Force | Out-Null
                      
                      # Backup snapshot
                      Get-Process | Where-Object {$_.ProcessName -like "*rdp*" -or $_.ProcessName -like "*term*"} | 
                          Select-Object ProcessName, CPU, WorkingSet | 
                          Export-Csv "$hourlyBackupDir\processes.csv" -NoTypeInformation
                      
                      # Kompres dan hapus
                      $hourlyBackupZip = "$env:TEMP\AISTV_Hourly_$(Get-Date -Format 'HHmmss').zip"
                      Compress-Archive -Path "$hourlyBackupDir\*" -DestinationPath $hourlyBackupZip -Force
                      Remove-Item $hourlyBackupDir -Recurse -Force
                      
                      Write-Host "[HOURLY BACKUP] $(Get-Date -Format 'HH:mm:ss') - Backup snapshot dibuat" -ForegroundColor Blue
                      $lastBackupTime = $currentTime
                      
                  } catch {
                      Write-Host "[BACKUP ERROR] Gagal membuat backup hourly" -ForegroundColor Red
                  }
              }
              
              $timeUntilRestart = $restartInterval - $elapsed
              
              if ($timeUntilRestart -le 0) {
                  $restartCount++
                  Write-Host ""
                  Write-Host "ğŸ¯ RESTART KE-$restartCount" -ForegroundColor Yellow
                  Write-Host "ğŸ’¾ Membuat pre-restart backup..." -ForegroundColor Cyan
                  
                  # Buat pre-restart backup
                  try {
                      $preRestartBackup = @{
                          RestartCount = $restartCount
                          LastRunTime = ($currentTime - $startTime).TotalHours
                          NextRestart = (Get-Date).AddHours(6).ToString("yyyy-MM-dd HH:mm:ss")
                          SystemStatus = "Healthy"
                      } | ConvertTo-Json
                      
                      $preRestartBackup | Out-File "$env:TEMP\pre_restart_backup.json"
                      Write-Host "â”‚ âœ… Pre-restart backup dibuat" -ForegroundColor Green
                      
                  } catch {
                      Write-Host "â”‚ âš ï¸  Gagal membuat pre-restart backup" -ForegroundColor Yellow
                  }
                  
                  echo "RESTART_COUNT=$restartCount" >> $env:GITHUB_ENV
                  echo "LAST_RESTART=$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $env:GITHUB_ENV
                  
                  Write-Host "â¸ï¸  Jeda 10 detik sebelum restart..." -ForegroundColor Green
                  for($i = 10; $i -gt 0; $i--) {
                      Write-Host "`râ³ Restart dalam: $i detik" -NoNewline -ForegroundColor Yellow
                      Start-Sleep -Seconds 1
                  }
                  Write-Host "`rğŸš€ Memulai restart...                    " -ForegroundColor Green
                  
                  $startTime = Get-Date
                  continue
              }
              
              $hours = [math]::Floor($timeUntilRestart / 3600)
              $minutes = [math]::Floor(($timeUntilRestart % 3600) / 60)
              $seconds = [math]::Floor($timeUntilRestart % 60)
              
              Write-Host "`râ³ Restart dalam: $hours jam $minutes menit $seconds detik | Backup berikutnya: $([math]::Floor(($backupInterval - ($currentTime - $lastBackupTime).TotalSeconds)/60)) menit" -NoNewline -ForegroundColor Cyan
              Start-Sleep -Seconds 5
          }

      # HIá»‚N THá»Š GIAO DIá»†N Äáº¸P DENGAN INFO BACKUP
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I & BACKUP
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if (-not $matKhau) {
              $matKhau = "KhÃ´ng thá»ƒ Ä‘á»c máº­t kháº©u"
          }
          
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianRestart = $thoiGianBatDau.AddHours(6)
          
          # Hitung backup yang tersedia
          $backupCount = (Get-ChildItem "$env:TEMP\AISTV_Backup\Scheduled\*.zip" -ErrorAction SilentlyContinue).Count
          $backupSize = [math]::Round((Get-ChildItem "$env:TEMP\AISTV_Backup\Scheduled\*.zip" -ErrorAction SilentlyContinue | 
              Measure-Object Length -Sum).Sum / 1MB, 2)
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚       ğŸ‰ Káº¾T Ná»I THÃ€NH CÃ”NG!              â”‚" -ForegroundColor Cyan
          Write-Host "â”‚       ğŸ’¾ SISTEM BACKUP: AKTIF             â”‚" -ForegroundColor Green
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ  Äá»‹a chá»‰: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤  TÃ i khoáº£n: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Máº­t kháº©u: $matKhau" -ForegroundColor White
          Write-Host "â”‚ â°  Thá»i lÆ°á»£ng: 6 JAM (Restart Otomatis)" -ForegroundColor White
          Write-Host "â”‚ ğŸ•  Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ”„  Restart berikut: $($thoiGianRestart.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ’¾  Backup tersedia: $backupCount file" -ForegroundColor White
          Write-Host "â”‚ ğŸ“Š  Ukuran backup: $backupSize MB" -ForegroundColor White
          Write-Host "â”‚ ğŸ“  Port: 3389" -ForegroundColor White
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸ’¡  FITUR BACKUP:                                 â”‚" -ForegroundColor Cyan
          Write-Host "â”‚   â€¢ Backup otomatis setiap 1 jam                  â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   â€¢ Backup full setiap 6 jam                     â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   â€¢ Retensi: 10 backup terbaru                   â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   â€¢ Backup registry, service, network           â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   â€¢ Auto-cleanup backup lama                    â”‚" -ForegroundColor Yellow
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

      # DUY TRÃŒ PHIÃŠN á»”N Äá»ŠNH DENGAN MONITOR BACKUP
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C DENGAN BACKUP
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianRestart = $thoiGianBatDau.AddHours(6)
          
          Write-Host ""
          Write-Host "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow
          Write-Host "ğŸ’ PhiÃªn: AI STV PREMIUM" -ForegroundColor Magenta
          Write-Host "ğŸ”— Káº¿t ná»‘i: $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "ğŸ’¾ Backup System: ACTIVE" -ForegroundColor Green
          Write-Host "ğŸ• Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor Green
          Write-Host "ğŸ”„ Restart: $($thoiGianRestart.ToString('HH:mm:ss'))" -ForegroundColor Yellow
          Write-Host "ğŸ“Š Backup Interval: 1 jam" -ForegroundColor Blue
          Write-Host ""
          
          # Monitor system dengan backup status
          $monitorScript = {
              $lastLogTime = Get-Date
              $restartTimer = Get-Date
              $restartInterval = 6 * 60 * 60
              $backupInterval = 3600
              $lastBackupTime = Get-Date
              
              while ($true) {
                  $currentTime = Get-Date
                  $elapsedRestart = ($currentTime - $restartTimer).TotalSeconds
                  $elapsedBackup = ($currentTime - $lastBackupTime).TotalSeconds
                  
                  # Log status setiap 5 menit
                  if (($currentTime - $lastLogTime).TotalMinutes -ge 5) {
                      $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                      $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
                      
                      # Check backup status
                      $backupFiles = Get-ChildItem "$env:TEMP\AISTV_Backup\Scheduled\*.zip" -ErrorAction SilentlyContinue
                      $backupCount = $backupFiles.Count
                      $lastBackupSize = if ($backupFiles) { 
                          [math]::Round(($backupFiles | Sort-Object LastWriteTime -Descending | Select-Object -First 1).Length / 1KB, 2) 
                      } else { 0 }
                      
                      $timeUntilRestart = $restartInterval - $elapsedRestart
                      $hours = [math]::Floor($timeUntilRestart / 3600)
                      $minutes = [math]::Floor(($timeUntilRestart % 3600) / 60)
                      
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ“Š Status - RDP: $($termService.Status), Koneksi: $($rdpConnections.Count), Backup: $backupCount files ($lastBackupSize KB), Restart dalam: $hours jam $minutes menit" -ForegroundColor Blue
                      $lastLogTime = $currentTime
                  }
                  
                  # Auto backup setiap 1 jam
                  if ($elapsedBackup -ge $backupInterval) {
                      try {
                          $backupDir = "$env:TEMP\Auto_Backup_$(Get-Date -Format 'HHmmss')"
                          New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
                          
                          # Quick backup
                          Get-Service TermService, UmRdpService | Select-Object Name, Status | Export-Csv "$backupDir\quick_services.csv" -NoTypeInformation
                          Get-Process | Where-Object {$_.WorkingSet -gt 100MB} | Select-Object ProcessName, CPU, WorkingSet | Export-Csv "$backupDir\large_processes.csv" -NoTypeInformation
                          
                          # Kompres
                          $backupZip = "$env:TEMP\AISTV_Backup\Scheduled\Quick_Backup_$(Get-Date -Format 'HHmmss').zip"
                          Compress-Archive -Path "$backupDir\*" -DestinationPath $backupZip -Force
                          Remove-Item $backupDir -Recurse -Force
                          
                          Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ’¾ Quick backup dibuat: $([math]::Round((Get-Item $backupZip).Length/1KB, 2)) KB" -ForegroundColor Green
                          $lastBackupTime = $currentTime
                          
                      } catch {
                          Write-Host "[$($currentTime.ToString('HH:mm:ss'))] âš ï¸  Gagal membuat quick backup" -ForegroundColor Yellow
                      }
                  }
                  
                  # Cek waktu restart
                  if ($elapsedRestart -ge $restartInterval) {
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ”„ WAKTU RESTART TELAH TIBA!" -ForegroundColor Yellow
                      
                      # Buat final backup sebelum restart
                      try {
                          $finalBackup = @{
                              Timestamp = $currentTime.ToString("yyyy-MM-dd HH:mm:ss")
                              Uptime = [math]::Round($elapsedRestart / 3600, 2)
                              Status = "Pre-Restart"
                          } | ConvertTo-Json
                          
                          $finalBackup | Out-File "$env:TEMP\AISTV_Backup\final_pre_restart.json"
                      } catch { }
                      
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] â¸ï¸  Jeda 10 detik sebelum restart..." -ForegroundColor Cyan
                      
                      for($i = 10; $i -gt 0; $i--) {
                          Write-Host "`r[$($currentTime.ToString('HH:mm:ss'))] â³ Restart dalam: $i detik" -NoNewline -ForegroundColor Yellow
                          Start-Sleep -Seconds 1
                      }
                      
                      Write-Host "`r[$($currentTime.ToString('HH:mm:ss'))] ğŸš€ Memulai restart sistem...                    " -ForegroundColor Green
                      $restartTimer = Get-Date
                  }
                  
                  # Kiá»ƒm tra service
                  $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  if ($termService.Status -ne 'Running') {
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ”„ Khá»Ÿi Ä‘á»™ng láº¡i TermService..." -ForegroundColor Yellow
                      Start-Service -Name TermService -ErrorAction SilentlyContinue
                  }
                  
                  Start-Sleep -Seconds 30
              }
          }
          
          # Jalankan monitor di background
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"
          
          # Timer utama dengan info backup
          $frames = @('â ‹', 'â ™', 'â ¹', 'â ¸', 'â ¼', 'â ´', 'â ¦', 'â §', 'â ‡', 'â ')
          $colors = @('Red', 'Yellow', 'Green', 'Cyan', 'Blue', 'Magenta')
          $startTime = Get-Date
          $restartInterval = 6 * 60 * 60
          $backupInterval = 3600
          $lastBackupTime = Get-Date
          $backupCount = 0
          
          while ($true) {
              $thoiGianHienTai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $elapsed = $thoiGianHienTai - $thoiGianBatDau
              
              $timeUntilRestart = $restartInterval - $elapsed.TotalSeconds
              $timeUntilBackup = $backupInterval - ($elapsed.TotalSeconds % $backupInterval)
              
              $gioDaChay = [math]::Floor($elapsed.TotalHours)
              $phutDaChay = [math]::Floor($elapsed.TotalMinutes % 60)
              $giayDaChay = [math]::Floor($elapsed.TotalSeconds % 60)
              
              $hoursToRestart = [math]::Floor($timeUntilRestart / 3600)
              $minutesToRestart = [math]::Floor(($timeUntilRestart % 3600) / 60)
              $secondsToRestart = [math]::Floor($timeUntilRestart % 60)
              
              $minutesToBackup = [math]::Floor($timeUntilBackup / 60)
              $secondsToBackup = [math]::Floor($timeUntilBackup % 60)
              
              # Update backup count
              $currentBackupCount = (Get-ChildItem "$env:TEMP\AISTV_Backup\Scheduled\*.zip" -ErrorAction SilentlyContinue).Count
              if ($currentBackupCount -gt $backupCount) {
                  $backupCount = $currentBackupCount
              }
              
              $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
              $color = $colors[([int]((Get-Date) - $startTime).TotalMinutes) % $colors.Length]
              
              if ($timeUntilRestart -le 300) {
                  $color = 'Red'
                  $frame = 'âš ï¸'
              } elseif ($timeUntilRestart -le 1800) {
                  $color = 'Yellow'
              }
              
              Write-Host "`r$frame [$($thoiGianHienTai.ToString('HH:mm:ss'))] Waktu: $gioDaChay jam $phutDaChay mnt | Restart: $hoursToRestart jam $minutesToRestart mnt | Backup: $backupCount files | Backup berikut: $minutesToBackup mnt $secondsToBackup dtk" -NoNewline -ForegroundColor $color
              
              if ($timeUntilRestart -le 0) {
                  Write-Host ""
                  Write-Host "ğŸ”„ WAKTU RESTART!" -ForegroundColor Yellow
                  Write-Host "ğŸ’¾ Membuat final backup..." -ForegroundColor Cyan
                  
                  # Final backup sebelum restart
                  try {
                      $finalBackupInfo = @{
                          FinalBackupTime = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                          TotalUptime = "$gioDaChay jam $phutDaChay menit"
                          TotalBackups = $backupCount
                          NextRestart = (Get-Date).AddHours(6).ToString("yyyy-MM-dd HH:mm:ss")
                      } | ConvertTo-Json
                      
                      $finalBackupInfo | Out-File "$env:TEMP\AISTV_Final_Backup_Info.json"
                      Write-Host "âœ… Final backup info disimpan" -ForegroundColor Green
                      
                  } catch {
                      Write-Host "âš ï¸  Gagal menyimpan final backup info" -ForegroundColor Yellow
                  }
                  
                  Write-Host "â¸ï¸  Jeda 10 detik sebelum restart..." -ForegroundColor Cyan
                  
                  for($i = 10; $i -gt 0; $i--) {
                      Write-Host "`râ³ Restart dalam: $i detik" -NoNewline -ForegroundColor Yellow
                      Start-Sleep -Seconds 1
                  }
                  
                  Write-Host "`rğŸš€ Memulai restart sistem...                    " -ForegroundColor Green
                  Write-Host "âœ… Sistem akan restart otomatis" -ForegroundColor Green
                  break
              }
              
              Start-Sleep -Seconds 5
          }

      # BACKUP FINAL DAN EKSPOR
      - name: ğŸ“¤ BACKUP FINAL DAN EKSPOR
        if: always()
        run: |
          Write-Host ""
          Write-Host "ğŸ“¤ BACKUP FINAL DAN EKSPOR" -ForegroundColor Yellow
          Write-Host "ğŸ”„ Mengumpulkan semua backup..." -ForegroundColor Cyan
          
          try {
              # Kumpulkan semua backup
              $backupSources = @(
                  "$env:TEMP\AISTV_Backup",
                  "$env:TEMP\AISTV_Initial_Backup_*.zip",
                  "$env:TEMP\AISTV_Final_Backup.zip",
                  "$env:TEMP\AISTV_Final_Backup_Info.json",
                  "$env:TEMP\pre_restart_backup.json"
              )
              
              $finalBackupDir = "$env:TEMP\AISTV_COMPLETE_BACKUP_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
              New-Item -ItemType Directory -Path $finalBackupDir -Force | Out-Null
              
              # Salin semua backup
              foreach($source in $backSources) {
                  if (Test-Path $source) {
                      if (Test-Path $source -PathType Container) {
                          Copy-Item -Path "$source\*" -Destination $finalBackupDir -Recurse -Force
                      } else {
                          Copy-Item -Path $source -Destination $finalBackupDir -Force
                      }
                  }
              }
              
              # Buat manifest backup
              $backupManifest = @{
                  BackupTime = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                  TotalFiles = (Get-ChildItem $finalBackupDir -Recurse -File).Count
                  TotalSizeMB = [math]::Round((Get-ChildItem $finalBackupDir -Recurse -File | Measure-Object Length -Sum).Sum / 1MB, 2)
                  Components = @("Registry", "Services", "Network", "System", "User", "Logs")
                  Retention = "7 days"
                  BackupVersion = "1.0"
              } | ConvertTo-Json
              
              $backupManifest | Out-File "$finalBackupDir\BACKUP_MANIFEST.json"
              
              # Kompres semua backup
              $completeBackupZip = "$env:TEMP\AISTV_COMPLETE_BACKUP_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
              Compress-Archive -Path "$finalBackupDir\*" -DestinationPath $completeBackupZip -Force
              
              # Hitung statistik
              $backupStats = @{
                  FileName = $completeBackupZip
                  SizeMB = [math]::Round((Get-Item $completeBackupZip).Length / 1MB, 2)
                  FileCount = (Get-ChildItem $finalBackupDir -Recurse -File).Count
                  Created = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              } | ConvertTo-Json
              
              $backupStats | Out-File "$env:TEMP\backup_statistics.json"
              
              echo "COMPLETE_BACKUP=$completeBackupZip" >> $env:GITHUB_ENV
              
              Write-Host "â”‚ âœ… Backup final berhasil dibuat" -ForegroundColor Green
              Write-Host "â”‚ ğŸ“ File: $completeBackupZip" -ForegroundColor White
              Write-Host "â”‚ ğŸ“Š Ukuran: $([math]::Round((Get-Item $completeBackupZip).Length/1MB, 2)) MB" -ForegroundColor White
              Write-Host "â”‚ ğŸ“ˆ Total file: $(Get-ChildItem $finalBackupDir -Recurse -File).Count" -ForegroundColor White
              
              # Upload ke GitHub Artifacts (opsional)
              Write-Host "â”‚ ğŸ”„ Menyiapkan upload ke artifacts..." -ForegroundColor Blue
              
          } catch {
              Write-Host "â”‚ âŒ Error membuat backup final: $_" -ForegroundColor Red
          }
          
          Write-Host "ğŸ¯ Proses backup final selesai!" -ForegroundColor Green

      # UPLOAD BACKUP KE GITHUB ARTIFACTS
      - name: ğŸ“¤ UPLOAD BACKUP KE ARTIFACTS
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aistv-rdp-backup
          path: |
            ${{ env.COMPLETE_BACKUP }}
            $env:TEMP\backup_statistics.json
            $env:TEMP\AISTV_Backup\
          retention-days: 7

      # Dá»ŒN Dáº¸P DENGAN BACKUP DATA
      - name: ğŸ§¹ Dá»ŒN Dáº¸P DENGAN PRESERVASI BACKUP
        if: always()
        run: |
          Write-Host ""
          Write-Host "ğŸ§¹ Dá»ŒN Dáº¸P DENGAN PRESERVASI BACKUP" -ForegroundColor Yellow
          Write-Host "ğŸ’¾ Memastikan backup tersimpan..." -ForegroundColor Cyan
          
          # Simpan info backup terakhir
          $cleanupInfo = @{
              CleanupTime = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              BackupLocation = if (Test-Path "$env:COMPLETE_BACKUP") { "$env:COMPLETE_BACKUP" } else { "Tidak ada backup" }
              BackupSize = if (Test-Path "$env:COMPLETE_BACKUP") { [math]::Round((Get-Item "$env:COMPLETE_BACKUP").Length / 1MB, 2) } else { 0 }
              ArtifactsUploaded = $true
          } | ConvertTo-Json
          
          $cleanupInfo | Out-File "$env:TEMP\cleanup_report.json"
          
          $cleanupSteps = @(
              @{Name="Simpan laporan cleanup"; Script={
                  # Sudah dilakukan di atas
              }},
              @{Name="XÃ³a file password temporary"; Script={
                  Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
              }},
              @{Name="VÃ´ hiá»‡u hÃ³a user sementara"; Script={
                  Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              }},
              @{Name="ÄÃ³ng káº¿t ná»‘i Tailscale"; Script={
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 5
              }},
              @{Name="XÃ³a rule firewall temporary"; Script={
                  netsh advfirewall firewall delete rule name="RDP-Premium" dir=in -ErrorAction SilentlyContinue
                  netsh advfirewall firewall delete rule name="RDP-Premium-Out" dir=out -ErrorAction SilentlyContinue
              }},
              @{Name="KhÃ´i phá»¥c cÃ i Ä‘áº·t RDP default"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
                  Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
              }},
              @{Name="Hentikan semua background jobs"; Script={
                  Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
              }},
              @{Name="Simpan log terakhir"; Script={
                  $finalLog = @{
                      FinalMessage = "Sistem cleanup selesai"
                      Timestamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                      NextSchedule = (Get-Date).AddHours(6).ToString("yyyy-MM-dd HH:mm:ss")
                  } | ConvertTo-Json
                  $finalLog | Out-File "$env:TEMP\final_system_log.json"
              }}
          )
          
          foreach($step in $cleanupSteps) {
              Write-Host "â”‚ ğŸ—‘ï¸  $($step.Name)..." -NoNewline -ForegroundColor Gray
              try {
                  & $step.Script
                  Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`râ”‚ âš ï¸  $($step.Name) - Aman" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }
          
          Write-Host ""
          Write-Host "ğŸ“Š LAPORAN BACKUP:" -ForegroundColor Cyan
          if (Test-Path "$env:TEMP\backup_statistics.json") {
              $stats = Get-Content "$env:TEMP\backup_statistics.json" | ConvertFrom-Json
              Write-Host "â”‚ ğŸ“ Backup: $($stats.FileName)" -ForegroundColor White
              Write-Host "â”‚ ğŸ“Š Ukuran: $($stats.SizeMB) MB" -ForegroundColor White
              Write-Host "â”‚ ğŸ“ˆ File count: $($stats.FileCount)" -ForegroundColor White
              Write-Host "â”‚ ğŸ• Dibuat: $($stats.Created)" -ForegroundColor White
          }
          
          Write-Host ""
          Write-Host "ğŸ‰ Cleanup selesai! Backup tersimpan di Artifacts GitHub." -ForegroundColor Green
          Write-Host "â° Restart berikutnya: $(Get-Date).AddHours(6).ToString('HH:mm:ss')" -ForegroundColor Yellow
          Write-Host "ğŸ’¾ Semua data penting telah di-backup!" -ForegroundColor Cyan
          Write-Host "ğŸ‘‹ Háº¹n gáº·p láº¡i di sesi berikutnya! ğŸ”„" -ForegroundColor Magenta
