name: ğŸš€ AI STV PREMIUM - INSTANT RESTART (NO DELAY)

on:
  workflow_dispatch:
  schedule:
    # Restart otomatis setiap 6 jam tanpa jeda
    - cron: '0 */6 * * *'

jobs:
  Premium-RDP-Instant:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 jam maksimal
    
    steps:
      # STEP 1: LOAD & IMMEDIATE START
      - name: ğŸš€ INSTANT START - NO DELAY
        run: |
          Write-Host ""
          Write-Host "ğŸš€ AI STV PREMIUM - INSTANT MODE" -ForegroundColor Red
          Write-Host "âš¡ No 10s Delay on Restart" -ForegroundColor Yellow
          Write-Host "â° Start Time: $(Get-Date -Format 'HH:mm:ss')" -ForegroundColor White
          
          # Create instant flag
          $instantFlag = @{
              ImmediateRestart = $true
              StartTime = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
              RestartSchedule = (Get-Date).AddHours(6).ToString("yyyy-MM-dd HH:mm:ss")
              NoDelayMode = "ENABLED"
          } | ConvertTo-Json
          
          $instantFlag | Out-File "$env:TEMP\instant_mode.json"
          
          Write-Host "âœ… Instant mode activated" -ForegroundColor Green

      # STEP 2: SYSTEM SETUP (INSTANT)
      - name: âš¡ SYSTEM SETUP INSTANT
        run: |
          Write-Host ""
          Write-Host "âš¡ SYSTEM SETUP - NO DELAY" -ForegroundColor Yellow
          
          # Enable RDP instantly
          $setupSteps = @(
              @{Name="Enable Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Disable Network Auth"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Configure Security Layer"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
              }},
              @{Name="Open Firewall Port 3389"; Script={
                  netsh advfirewall firewall add rule name="RDP-Instant-6H" dir=in action=allow protocol=TCP localport=3389
                  netsh advfirewall firewall add rule name="RDP-Instant-6H-Out" dir=out action=allow protocol=TCP localport=3389
              }},
              @{Name="Start Services"; Script={
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
              }}
          )
          
          foreach($step in $setupSteps) {
              Write-Host "â”‚ âš¡ $($step.Name)" -ForegroundColor White
              try {
                  & $step.Script
              } catch {
                  Write-Host "â”‚ âš ï¸  $($step.Name) - Skipped" -ForegroundColor Yellow
              }
          }
          
          Write-Host "âœ… System setup complete" -ForegroundColor Green

      # STEP 3: CREATE USER WITH VALID PASSWORD (FIXED)
      - name: ğŸ”„ CREATE USER - FIXED PASSWORD
        run: |
          Write-Host ""
          Write-Host "ğŸ”„ CREATING USER WITH VALID PASSWORD" -ForegroundColor Yellow
          
          # Password yang sudah teruji valid untuk Windows
          # Mengikuti semua policy: 8+ chars, uppercase, lowercase, number, symbol
          $plainPass = "AiSTV@2024Pwd!"
          
          Write-Host "â”‚ ğŸ” Using pre-validated password" -ForegroundColor Green
          Write-Host "â”‚ ğŸ“‹ Password: $plainPass" -ForegroundColor White
          
          # Remove old user if exists
          try {
              Remove-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… Old user removed" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ â„¹ï¸ No old user found" -ForegroundColor Blue
          }
          
          # Method 1: Try net user (most reliable)
          Write-Host "â”‚ ğŸ‘¤ Creating user with net command..." -ForegroundColor Cyan
          
          # Disable password complexity temporarily for this session
          try {
              # Backup current policy
              secedit /export /cfg "$env:TEMP\sec_policy_backup.cfg" 2>$null
              
              # Create temporary policy without complexity
              $tempPolicy = @"
[Unicode]
Unicode=yes
[System Access]
MinimumPasswordAge = 0
MaximumPasswordAge = 90
MinimumPasswordLength = 1
PasswordComplexity = 0
PasswordHistorySize = 0
LockoutBadCount = 0
RequireLogonToChangePassword = 0
ForceLogoffWhenHourExpire = 0
[Registry Values]
[Privilege Rights]
[Version]
signature="`$CHICAGO`$"
Revision=1
"@
              
              $tempPolicy | Out-File "$env:TEMP\nosec.cfg" -Encoding Unicode
              secedit /configure /db "$env:TEMP\nosec.sdb" /cfg "$env:TEMP\nosec.cfg" 2>$null
              Write-Host "â”‚ âœ… Password complexity disabled temporarily" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âš ï¸ Could not disable password complexity" -ForegroundColor Yellow
          }
          
          # Create user with net user command
          $netResult = net user "AISTV-PREMIUM" $plainPass /ADD /EXPIRES:NEVER /Y 2>&1
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "â”‚ âœ… User created with net user" -ForegroundColor Green
              
              # Add to groups
              net localgroup "Administrators" "AISTV-PREMIUM" /ADD 2>$null
              net localgroup "Remote Desktop Users" "AISTV-PREMIUM" /ADD 2>$null
              
              # Enable account
              net user "AISTV-PREMIUM" /ACTIVE:YES 2>$null
              
              # Set password never expires
              wmic useraccount where "name='AISTV-PREMIUM'" set PasswordExpires=False 2>$null
              
              Write-Host "â”‚ âœ… Added to Admin & RDP groups" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ Net user failed: $netResult" -ForegroundColor Red
              
              # Method 2: Try PowerShell with secure password
              Write-Host "â”‚ ğŸ”„ Trying PowerShell method..." -ForegroundColor Yellow
              try {
                  $securePass = ConvertTo-SecureString $plainPass -AsPlainText -Force
                  New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
                  
                  Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
                  Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM" -ErrorAction SilentlyContinue
                  
                  Enable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
                  
                  Write-Host "â”‚ âœ… User created with PowerShell" -ForegroundColor Green
              } catch {
                  Write-Host "â”‚ âŒ PowerShell failed: $($_.Exception.Message)" -ForegroundColor Red
                  
                  # Method 3: Last resort - use existing/default account
                  Write-Host "â”‚ ğŸ†˜ Using fallback method..." -ForegroundColor Red
                  try {
                      # Try to enable Administrator account
                      net user "Administrator" /ACTIVE:YES 2>$null
                      net user "Administrator" $plainPass 2>$null
                      Write-Host "â”‚ âš ï¸ Using built-in Administrator account" -ForegroundColor Yellow
                      $plainPass = $plainPass  # Keep same password
                  } catch {
                      Write-Host "â”‚ âŒ All methods failed" -ForegroundColor Red
                      exit 1
                  }
              }
          }
          
          # Restore original security policy
          try {
              secedit /configure /db "$env:TEMP\restore.sdb" /cfg "$env:TEMP\sec_policy_backup.cfg" 2>$null
              Write-Host "â”‚ ğŸ”§ Security policy restored" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âš ï¸ Could not restore security policy" -ForegroundColor Yellow
          }
          
          # Save password for later steps
          $plainPass | Out-File "$env:TEMP\rdp_password.txt"
          echo "RDP_PASS=$plainPass" >> $env:GITHUB_ENV
          echo "RDP_USER=AISTV-PREMIUM" >> $env:GITHUB_ENV
          
          Write-Host "âœ… User setup complete" -ForegroundColor Green
          Write-Host "ğŸ‘¤ Username: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "ğŸ” Password: $plainPass" -ForegroundColor White

      # STEP 4: TAILSCALE INSTANT SETUP
      - name: ğŸŒ TAILSCALE INSTANT CONNECT
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "ğŸŒ TAILSCALE INSTANT SETUP" -ForegroundColor Yellow
          
          # Install Tailscale if not present
          $tailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $tailscaleExe)) {
              Write-Host "â”‚ ğŸ“¦ Installing Tailscale..." -ForegroundColor Blue
              $msiPath = "$env:TEMP\tailscale_install.msi"
              try {
                  Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
                  Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
                  Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
                  Write-Host "â”‚ âœ… Tailscale installed" -ForegroundColor Green
              } catch {
                  Write-Host "â”‚ âŒ Tailscale install failed" -ForegroundColor Red
              }
          }
          
          # Connect to Tailscale
          Write-Host "â”‚ ğŸ”— Connecting to Tailscale..." -ForegroundColor Cyan
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$env:GITHUB_RUN_ID --reset --accept-routes --accept-dns
          
          # Get IP address
          Start-Sleep -Seconds 5
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
          
          if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
              echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
              Write-Host "â”‚ âœ… Tailscale IP: $ip" -ForegroundColor Green
          } else {
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
              Write-Host "â”‚ âš ï¸ Using localhost for RDP" -ForegroundColor Yellow
          }
          
          # Save Tailscale status
          & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | Out-File "$env:TEMP\tailscale_status.json"
          
          Write-Host "âœ… Tailscale setup complete" -ForegroundColor Green

      # STEP 5: INSTANT RESTART MONITOR (NO 10s DELAY)
      - name: ğŸ”„ INSTANT RESTART MONITOR
        run: |
          Write-Host ""
          Write-Host "ğŸ”„ INSTANT RESTART MONITOR" -ForegroundColor Yellow
          Write-Host "â° Auto-restart in: 6 hours (NO DELAY)" -ForegroundColor Red
          
          # Calculate restart time
          $restartInterval = 6 * 60 * 60  # 6 hours in seconds
          $startTime = Get-Date
          $restartTime = $startTime.AddSeconds($restartInterval)
          
          # Start background job to trigger next workflow at exact time
          $restartJob = {
              param($intervalSeconds, $repo, $token)
              
              # Wait for the exact interval
              Start-Sleep -Seconds $intervalSeconds
              
              # Trigger new workflow immediately (NO DELAY)
              $uri = "https://api.github.com/repos/$repo/actions/workflows/premium-rdp-instant.yml/dispatches"
              $body = @{
                  ref = "main"
              } | ConvertTo-Json
              
              $headers = @{
                  Authorization = "token $token"
                  Accept = "application/vnd.github.v3+json"
              }
              
              try {
                  Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body -ErrorAction Stop
                  Write-Host "[AUTO-RESTART] âœ… New workflow triggered" -ForegroundColor Green
              } catch {
                  Write-Host "[AUTO-RESTART] âŒ Failed to trigger: $_" -ForegroundColor Red
              }
              
              # Immediately stop RDP services to free resources
              Stop-Service TermService -Force -ErrorAction SilentlyContinue
              Stop-Service UmRdpService -Force -ErrorAction SilentlyContinue
          }
          
          # Start the restart job in background
          Start-Job -ScriptBlock $restartJob -ArgumentList $restartInterval, $env:GITHUB_REPOSITORY, $env:GITHUB_TOKEN -Name "AutoRestartTrigger"
          
          Write-Host "âœ… Auto-restart monitor started" -ForegroundColor Green
          Write-Host "â° Next restart at: $($restartTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan

      # STEP 6: DISPLAY CONNECTION INFO
      - name: ğŸ¯ DISPLAY CONNECTION INFO
        run: |
          $password = Get-Content "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          if (-not $password) { 
              $password = $env:RDP_PASS 
              if (-not $password) { $password = "AiSTV@2024Pwd!" }
          }
          
          $startTime = Get-Date
          $restartTime = $startTime.AddHours(6)
          $timeRemaining = $restartTime - $startTime
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚              ğŸš€ AI STV PREMIUM RDP                    â”‚" -ForegroundColor Red
          Write-Host "â”‚              âš¡ INSTANT MODE - NO DELAY               â”‚" -ForegroundColor Yellow
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ RDP Address: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤ Username: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "â”‚ ğŸ” Password: $password" -ForegroundColor White
          Write-Host "â”‚ ğŸ“ Port: 3389" -ForegroundColor White
          Write-Host "â”‚ â° Session Start: $($startTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ”„ Auto Restart: $($restartTime.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ â³ Time Remaining: 6 hours 0 minutes" -ForegroundColor White
          Write-Host "â”‚ âš¡ Mode: INSTANT (No 10s delay on restart)" -ForegroundColor Red
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          
          # Save session info
          $sessionInfo = @{
              IP = $env:TAILSCALE_IP
              Username = "AISTV-PREMIUM"
              Password = $password
              StartTime = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
              RestartTime = $restartTime.ToString("yyyy-MM-dd HH:mm:ss")
              Mode = "Instant-NoDelay"
          } | ConvertTo-Json
          
          $sessionInfo | Out-File "$env:TEMP\session_info.json"

      # STEP 7: MAINTAIN SESSION UNTIL INSTANT RESTART
      - name: â³ MAINTAIN SESSION - INSTANT RESTART
        run: |
          Write-Host ""
          Write-Host "â³ MAINTAINING SESSION..." -ForegroundColor Yellow
          
          $sessionStart = Get-Date
          $restartTime = $sessionStart.AddHours(6)
          $checkInterval = 30  # Check every 30 seconds
          
          Write-Host "âœ… Session active" -ForegroundColor Green
          Write-Host "â° Next restart at: $($restartTime.ToString('HH:mm:ss'))" -ForegroundColor Cyan
          Write-Host "âš¡ Mode: Instant restart (No 10s delay)" -ForegroundColor Red
          
          while ($true) {
              $currentTime = Get-Date
              $timeRemaining = $restartTime - $currentTime
              
              # Check if it's time to restart
              if ($timeRemaining.TotalSeconds -le 0) {
                  Write-Host ""
                  Write-Host "ğŸ”„ RESTART TIME REACHED!" -ForegroundColor Red
                  Write-Host "âš¡ Initiating immediate restart (NO DELAY)..." -ForegroundColor Yellow
                  
                  # Stop services immediately
                  Stop-Service TermService -Force -ErrorAction SilentlyContinue
                  Stop-Service UmRdpService -Force -ErrorAction SilentlyContinue
                  
                  # Disconnect Tailscale
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
                  
                  Write-Host "âœ… Services stopped" -ForegroundColor Green
                  Write-Host "ğŸ¯ Exiting for immediate restart" -ForegroundColor Green
                  break
              }
              
              # Calculate remaining time
              $hours = [math]::Floor($timeRemaining.TotalHours)
              $minutes = [math]::Floor($timeRemaining.TotalMinutes % 60)
              $seconds = [math]::Floor($timeRemaining.TotalSeconds % 60)
              
              # Display countdown
              Write-Host "`râ³ Time until restart: $hours hours $minutes minutes $seconds seconds" -NoNewline -ForegroundColor Cyan
              
              # Check RDP service status
              $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
              if ($termService.Status -ne 'Running') {
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Write-Host "`nâ”‚ ğŸ”„ Restarted TermService" -ForegroundColor Yellow
              }
              
              # Check user account status
              $user = Get-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              if ($user -and -not $user.Enabled) {
                  Enable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
                  Write-Host "`nâ”‚ ğŸ”„ Re-enabled user account" -ForegroundColor Yellow
              }
              
              Start-Sleep -Seconds $checkInterval
          }

      # STEP 8: INSTANT CLEANUP (Optional - runs if workflow fails)
      - name: ğŸ§¹ INSTANT CLEANUP (ON FAILURE)
        if: failure()
        run: |
          Write-Host ""
          Write-Host "ğŸ§¹ INSTANT CLEANUP ON FAILURE" -ForegroundColor Yellow
          
          # Minimal cleanup to allow immediate restart
          try {
              # Stop services
              Stop-Service TermService -Force -ErrorAction SilentlyContinue
              Stop-Service UmRdpService -Force -ErrorAction SilentlyContinue
              
              # Disable user temporarily
              Disable-LocalUser -Name "AISTV-PREMIUM" -ErrorAction SilentlyContinue
              
              # Down Tailscale
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
              
              Write-Host "âœ… Cleanup complete" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸ Partial cleanup completed" -ForegroundColor Yellow
          }
          
          Write-Host "âš¡ Ready for immediate restart" -ForegroundColor Green

# Workflow untuk memicu restart (optional trigger)
  Trigger-Instant-Restart:
    runs-on: ubuntu-latest
    needs: [Premium-RDP-Instant]
    if: always()
    steps:
      - name: ğŸš€ Trigger Next Session
        if: success() || failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âš¡ Triggering next instant session..."
          
          # Wait a moment for cleanup
          sleep 5
          
          # Trigger the same workflow again
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/premium-rdp-instant.yml/dispatches \
            -d '{"ref":"main"}'
          
          echo "âœ… Next session triggered successfully!"
