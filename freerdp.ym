name: ğŸš€ SEVER AI STV PREMIUM

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: ubuntu-latest  # Menggunakan Ubuntu terbaru (saat ini 22.04, tapi bisa diupdate ke 24.04 jika tersedia)
    timeout-minutes: 340
    
    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          echo ""
          echo ""
          echo "ğŸ¤– AI STV PREMIUM RDP SERVER" 
          echo "âš¡ Powered by AI STV" 
          echo "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" 
          echo ""
          
          # Hiá»‡u á»©ng loading
          frames=('â£¾' 'â£½' 'â£»' 'â¢¿' 'â¡¿' 'â£Ÿ' 'â£¯' 'â£·')
          for i in {1..10}; do
              echo -ne "\rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... ${frames[$((i % 8))]}" 
              sleep 0.1
          done
          echo -e "\râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!                    "

      # Cáº¤U HÃŒNH NÃ‚NG CAO
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          echo ""
          echo "ğŸ› ï¸  ÄANG Cáº¤U HÃŒNH Há»† THá»NG"
          
          # Update system
          sudo apt update -y
          
          # Install desktop environment (XFCE4) and RDP server (xrdp)
          sudo apt install -y xfce4 xfce4-goodies xrdp tightvncserver
          
          # Configure xrdp
          sudo sed -i 's/port=3389/port=3389/' /etc/xrdp/xrdp.ini
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Open port 3389 in firewall
          sudo ufw allow 3389/tcp
          
          echo "ğŸ¯ Cáº¥u hÃ¬nh hoÃ n táº¥t!"

      # Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          echo ""
          echo "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM"
          
          # Function to generate password (8 chars, with upper, lower, number)
          generate_password() {
              upper="ABCDEFGHJKLMNPQRSTUVWXYZ"
              lower="abcdefghijkmnpqrstuvwxyz"
              numbers="23456789"
              all="$upper$lower$numbers"
              
              pw="${upper:$((RANDOM % ${#upper})):1}"
              pw+="${lower:$((RANDOM % ${#lower})):1}"
              pw+="${numbers:$((RANDOM % ${#numbers})):1}"
              
              for i in {1..5}; do
                  pw+="${all:$((RANDOM % ${#all})):1}"
              done
              
              # Shuffle
              echo "$pw" | fold -w1 | shuf | tr -d '\n'
          }
          
          # Use custom password if set
          if [ -n "$CUSTOM_RDP_PASS" ]; then
              matkhau="$CUSTOM_RDP_PASS"
              echo "â”‚ â„¹ï¸  DÃ¹ng máº­t kháº©u tÃ¹y chá»‰nh tá»« env"
          else
              matkhau=$(generate_password)
          fi
          
          # Remove old user if exists
          sudo userdel -r AISTV-PREMIUM 2>/dev/null || echo "â”‚ â„¹ï¸  KhÃ´ng cÃ³ user cÅ© Ä‘á»ƒ xÃ³a"
          
          # Create new user
          sudo useradd -m -s /bin/bash -p $(openssl passwd -1 "$matkhau") AISTV-PREMIUM
          sudo usermod -aG sudo AISTV-PREMIUM  # Add to sudo group
          
          # Set password never expires (approximation)
          sudo chage -m 0 -M 99999 -I -1 -E -1 AISTV-PREMIUM
          
          echo "RDP_USER=AISTV-PREMIUM" >> $GITHUB_ENV
          echo "RDP_PASS=$matkhau" >> $GITHUB_ENV
          echo "$matkhau" > /tmp/rdp_password.txt
          
          echo "âœ… TÃ i khoáº£n: AISTV-PREMIUM Ä‘Ã£ sáºµn sÃ ng"

      # KIá»‚M TRA QUYá»€N ÄÄ‚NG NHáº¬P
      - name: ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG
        run: |
          echo ""
          echo "ğŸ” KIá»‚M TRA QUYá»€N ÄÄ‚NG NHáº¬P"
          
          # Check user exists
          if id "AISTV-PREMIUM" &>/dev/null; then
              echo "â”‚ âœ… User AISTV-PREMIUM tá»“n táº¡i"
          else
              echo "â”‚ âŒ User khÃ´ng tá»“n táº¡i"
              exit 1
          fi
          
          # Check sudo group
          if groups AISTV-PREMIUM | grep -q sudo; then
              echo "â”‚ âœ… CÃ³ quyá»n sudo"
          else
              echo "â”‚ âŒ KhÃ´ng cÃ³ quyá»n sudo"
          fi
          
          # Check xrdp service
          if systemctl is-active --quiet xrdp; then
              echo "â”‚ âœ… Dá»‹ch vá»¥ xrdp Ä‘ang cháº¡y"
          else
              echo "â”‚ âŒ Dá»‹ch vá»¥ xrdp khÃ´ng cháº¡y"
          fi
          
          echo "ğŸ¯ Kiá»ƒm tra hoÃ n táº¥t!"

      # TAILSCALE PREMIUM
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo ""
          echo "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG"
          
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Connect Tailscale
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-$GITHUB_RUN_ID --accept-routes --accept-dns --reset
          
          # Get IP with retry
          echo "ğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP..."
          for i in {1..20}; do
              ip=$(tailscale ip -4 2>/dev/null)
              if [[ $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  echo "TAILSCALE_IP=$ip" >> $GITHUB_ENV
                  echo "âœ… Äá»‹a chá»‰ IP: $ip"
                  break
              fi
              echo -ne "\rğŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP... $(echo -n '.'; for j in {1..$i}; do echo -n '.'; done)"
              sleep 3
          done
          
          if [[ -z $ip || ! $ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "âš ï¸  KhÃ´ng thá»ƒ láº¥y IP, sá»­ dá»¥ng localhost"
              echo "TAILSCALE_IP=localhost" >> $GITHUB_ENV
          fi

      # HIá»‚N THá»Š GIAO DIá»†N Äáº¸P
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          matkhau=$(cat /tmp/rdp_password.txt 2>/dev/null || echo "KhÃ´ng thá»ƒ Ä‘á»c máº­t kháº©u")
          
          # Convert duration to minutes
          duration_input="${{ github.event.inputs.duration }}"
          case $duration_input in
              "1h") total_minutes=60; display_time="1 giá»" ;;
              "3h") total_minutes=180; display_time="3 giá»" ;;
              "5h40m") total_minutes=340; display_time="5 giá» 40 phÃºt" ;;
          esac
          
          # Calculate times (assuming UTC+7 for SE Asia)
          start_time=$(date -d "+7 hours" "+%H:%M:%S")
          end_time=$(date -d "+7 hours +$total_minutes minutes" "+%H:%M:%S")
          
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" 
          echo "â”‚              ğŸ‰ Káº¾T Ná»I THÃ€NH CÃ”NG!              â”‚" 
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" 
          echo "â”‚ ğŸŒ  Äá»‹a chá»‰: $TAILSCALE_IP" 
          echo "â”‚ ğŸ‘¤  TÃ i khoáº£n: AISTV-PREMIUM" 
          echo "â”‚ ğŸ”  Máº­t kháº©u: $matkhau" 
          echo "â”‚ â°  Thá»i lÆ°á»£ng: $display_time" 
          echo "â”‚ ğŸ•  Báº¯t Ä‘áº§u: $start_time" 
          echo "â”‚ ğŸ•  Káº¿t thÃºc: $end_time" 
          echo "â”‚ ğŸ“  Port: 3389" 
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" 
          echo "â”‚ ğŸ’¡  HÆ°á»›ng dáº«n:                                    â”‚" 
          echo "â”‚   1. Má»Ÿ Remote Desktop Connection                 â”‚" 
          echo "â”‚   2. Nháº­p: $TAILSCALE_IP                          â”‚" 
          echo "â”‚   3. User: AISTV-PREMIUM | Password: trÃªn          â”‚" 
          echo "â”‚   4. Enjoy! ğŸš€                                    â”‚" 
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" 
          
          echo "TOTAL_MINUTES=$total_minutes" >> $GITHUB_ENV

      # DUY TRÃŒ PHIÃŠN á»”N Äá»ŠNH
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          matkhau=$(cat /tmp/rdp_password.txt 2>/dev/null)
          total_minutes=$TOTAL_MINUTES
          
          start_time=$(date -d "+7 hours" "+%H:%M:%S")
          end_time=$(date -d "+7 hours +$total_minutes minutes" "+%H:%M:%S")
          
          echo ""
          echo "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..."
          echo "ğŸ’ PhiÃªn: AI STV PREMIUM"
          echo "ğŸ”— Káº¿t ná»‘i: $TAILSCALE_IP"
          echo "ğŸ• Báº¯t Ä‘áº§u: $start_time"
          echo "ğŸ• Káº¿t thÃºc: $end_time"
          echo ""
          
          # Monitor script in background
          (
              while true; do
                  current_time=$(date "+%H:%M:%S")
                  if systemctl is-active --quiet xrdp; then
                      status="Running"
                  else
                      status="Not Running"
                  fi
                  echo "[$current_time] ğŸ“Š Tráº¡ng thÃ¡i - xrdp: $status"
                  sleep 120  # Log every 2 minutes
              done
          ) &
          monitor_pid=$!
          
          # Timer
          frames=('â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ')
          colors=('31' '33' '32' '36' '34' '35')  # ANSI color codes
          start_seconds=$(date +%s)
          end_seconds=$((start_seconds + total_minutes * 60))
          
          while [ $(date +%s) -lt $end_seconds ]; do
              current_time=$(date "+%H:%M:%S")
              remaining_seconds=$((end_seconds - $(date +%s)))
              hours=$((remaining_seconds / 3600))
              minutes=$(( (remaining_seconds % 3600) / 60 ))
              seconds=$((remaining_seconds % 60))
              
              frame_index=$(( ($(date +%s) - start_seconds) % 10 ))
              color_index=$(( ($(date +%s) - start_seconds) / 60 % 6 ))
              echo -ne "\r${frames[$frame_index]} [$current_time] Thá»i gian cÃ²n láº¡i: $hours giá» $minutes phÃºt $seconds giÃ¢y" 
              echo -ne "\e[${colors[$color_index]}m"
              sleep 5
          done
          echo ""
          echo "ğŸ¯ ÄÃƒ Háº¾T THá»œI GIAN - Tá»° Äá»˜NG Dá»ªNG!"
          
          # Kill monitor
          kill $monitor_pid 2>/dev/null

      # Dá»ŒN Dáº¸P CHUYÃŠN NGHIá»†P
      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        run: |
          echo ""
          echo "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..."
          
          # Remove password file
          rm -f /tmp/rdp_password.txt
          
          # Disable user
          sudo usermod -L AISTV-PREMIUM 2>/dev/null
          
          # Disconnect Tailscale
          sudo tailscale down --accept-risk=all 2>/dev/null
          
          # Close firewall
          sudo ufw delete allow 3389/tcp
          
          # Stop xrdp
          sudo systemctl stop xrdp
          sudo systemctl disable xrdp
          
          echo ""
          echo "ğŸ‰ Dá»n dáº¹p hoÃ n táº¥t! Háº¹n gáº·p láº¡i! ğŸ‘‹"
